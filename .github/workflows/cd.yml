# ============================================
# TeachProxy CD (æŒç»­éƒ¨ç½²) å·¥ä½œæµ
# è‡ªåŠ¨éƒ¨ç½²åˆ° VPS æœåŠ¡å™¨
# ============================================

name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # -----------------------------------------
  # æ„å»º Docker é•œåƒ
  # -----------------------------------------
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: teachproxy:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # -----------------------------------------
  # éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
  # -----------------------------------------
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # é…ç½® SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          cat >> ~/.ssh/config << EOF
          Host deploy
            HostName ${{ secrets.SSH_HOST }}
            User ${{ secrets.SSH_USER }}
            Port ${{ secrets.SSH_PORT || '22' }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF

      # ä¿®å¤æƒé™å¹¶æ›´æ–°ä»£ç 
      - name: Fix permissions and update code
        run: |
          echo "ğŸ”§ Fixing permissions and updating code..."
          
          # ä¿®å¤ Git æƒé™å¹¶æ‹‰å–æœ€æ–°ä»£ç 
          ssh deploy "
            sudo git config --global --add safe.directory ~/teachproxy 2>/dev/null || true
            cd ~/teachproxy 2>/dev/null || mkdir -p ~/teachproxy && cd ~/teachproxy
            if [ -d .git ]; then
              sudo git fetch origin main
              sudo git reset --hard origin/main
            fi
          "
          
          echo "âœ… Code updated successfully"

      # éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: Deploy to server
        run: |
          echo "ğŸš€ Starting deployment..."
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          ssh deploy "mkdir -p ~/teachproxy"
          
          # å¤åˆ¶éƒ¨ç½²æ–‡ä»¶
          scp docker-compose.yml deploy:~/teachproxy/
          scp Dockerfile deploy:~/teachproxy/
          scp docker-entrypoint.sh deploy:~/teachproxy/
          scp pyproject.toml deploy:~/teachproxy/
          scp uv.lock deploy:~/teachproxy/
          scp -r nginx deploy:~/teachproxy/
          scp -r gateway deploy:~/teachproxy/
          scp -r admin deploy:~/teachproxy/
          scp -r web deploy:~/teachproxy/
          
          # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
          ssh deploy "cat > ~/teachproxy/.env << 'ENVFILE'
          # Database
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          
          # AI Providers
          DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_BASE_URL=${{ secrets.DEEPSEEK_BASE_URL }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
          
          # Balance Architecture
          TEACHER_DEEPSEEK_API_KEY=${{ secrets.TEACHER_DEEPSEEK_API_KEY }}
          TEACHER_OPENROUTER_API_KEY=${{ secrets.TEACHER_OPENROUTER_API_KEY }}
          
          # Security
          ADMIN_TOKEN=${{ secrets.ADMIN_TOKEN }}
          API_KEY_ENCRYPTION_KEY=${{ secrets.API_KEY_ENCRYPTION_KEY }}
          
          # Rate Limiting
          RATE_LIMIT_REQUESTS_PER_MINUTE=${{ secrets.RATE_LIMIT_REQUESTS_PER_MINUTE || '60' }}
          RATE_LIMIT_BURST_SIZE=${{ secrets.RATE_LIMIT_BURST_SIZE || '10' }}
          
          # Logging
          LOG_LEVEL=${{ secrets.LOG_LEVEL || 'INFO' }}
          LOG_FORMAT=${{ secrets.LOG_FORMAT || 'json' }}
          
          # Semester
          SEMESTER_START_DATE=${{ secrets.SEMESTER_START_DATE }}
          SEMESTER_WEEKS=${{ secrets.SEMESTER_WEEKS || '16' }}
          ENVFILE"
          
          # ç”Ÿæˆ Nginx é…ç½®æ–‡ä»¶
          ssh deploy "export DOMAIN=${{ secrets.DOMAIN }} && envsubst '\${DOMAIN}' < ~/teachproxy/nginx/conf.d/app.conf.template > ~/teachproxy/nginx/conf.d/app.conf"
          
          echo "âœ… Files copied successfully"

      # æ‰§è¡Œéƒ¨ç½²
      - name: Execute deployment
        run: |
          echo "ğŸ³ Pulling and starting containers..."
          
          ssh deploy << 'DEPLOY'
            cd ~/teachproxy
            
            # æ¸…ç†æ—§å®¹å™¨å’Œå·ï¼Œé¿å…ç¼“å­˜é—®é¢˜
            echo "ğŸ§¹ Cleaning up old containers and volumes..."
            docker compose down --volumes --remove-orphans 2>/dev/null || true
            docker system prune -af --volumes 2>/dev/null || true
            
            # æ‹‰å–æœ€æ–°ä»£ç å¹¶æ„å»º
            docker compose pull
            docker compose build --no-cache
            
            # ä¼˜é›…é‡å¯
            docker compose down --timeout 30
            docker compose up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ Waiting for services to start..."
            sleep 10
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ Running health check..."
            MAX_RETRIES=10
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… API is healthy"
                break
              fi
              
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "â³ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying..."
              sleep 5
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ Health check failed after $MAX_RETRIES attempts"
              docker compose logs api --tail 50
              exit 1
            fi
            
            # æ¸…ç†æ—§é•œåƒ
            docker image prune -af --filter "until=24h"
            
            echo "âœ… Deployment completed successfully!"
          DEPLOY

      # é€šçŸ¥éƒ¨ç½²ç»“æœ
      - name: Notify deployment result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "ğŸŒ Application is available at: https://${{ secrets.DOMAIN }}"
          else
            echo "âŒ Deployment failed!"
          fi
