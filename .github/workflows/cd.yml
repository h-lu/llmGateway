# ============================================
# TeachProxy CD (æŒç»­éƒ¨ç½²) å·¥ä½œæµ
# è‡ªåŠ¨éƒ¨ç½²åˆ° VPS æœåŠ¡å™¨
# ============================================

name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # -----------------------------------------
  # æ„å»º Docker é•œåƒ
  # -----------------------------------------
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: teachproxy:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # -----------------------------------------
  # éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
  # -----------------------------------------
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # é…ç½® SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          cat >> ~/.ssh/config << EOF
          Host deploy
            HostName ${{ secrets.SSH_HOST }}
            User ${{ secrets.SSH_USER }}
            Port ${{ secrets.SSH_PORT || '22' }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
          EOF

      # ä¿®å¤æƒé™å¹¶æ›´æ–°ä»£ç 
      - name: Fix permissions and update code
        run: |
          echo "ğŸ”§ Fixing permissions and updating code..."
          
          # ä¿®å¤ Git æƒé™å¹¶æ‹‰å–æœ€æ–°ä»£ç ï¼ˆä¸ä½¿ç”¨ sudoï¼Œé¿å…æƒé™é—®é¢˜ï¼‰
          ssh deploy "
            git config --global --add safe.directory ~/teachproxy 2>/dev/null || true
            cd ~/teachproxy 2>/dev/null || mkdir -p ~/teachproxy && cd ~/teachproxy
            if [ -d .git ]; then
              git fetch origin main
              git reset --hard origin/main
            fi
          "
          
          echo "âœ… Code updated successfully"

      # éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: Deploy to server
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_BASE_URL: ${{ secrets.DEEPSEEK_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          TEACHER_DEEPSEEK_API_KEY: ${{ secrets.TEACHER_DEEPSEEK_API_KEY }}
          TEACHER_OPENROUTER_API_KEY: ${{ secrets.TEACHER_OPENROUTER_API_KEY }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
          API_KEY_ENCRYPTION_KEY: ${{ secrets.API_KEY_ENCRYPTION_KEY }}
          STUDENT_REGISTRATION_CODE: ${{ secrets.STUDENT_REGISTRATION_CODE }}
          STUDENT_SELF_REGISTER_DEFAULT_QUOTA: ${{ secrets.STUDENT_SELF_REGISTER_DEFAULT_QUOTA }}
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
          RATE_LIMIT_REQUESTS_PER_MINUTE: ${{ secrets.RATE_LIMIT_REQUESTS_PER_MINUTE }}
          RATE_LIMIT_BURST_SIZE: ${{ secrets.RATE_LIMIT_BURST_SIZE }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
          LOG_FORMAT: ${{ secrets.LOG_FORMAT }}
          SEMESTER_START_DATE: ${{ secrets.SEMESTER_START_DATE }}
          SEMESTER_WEEKS: ${{ secrets.SEMESTER_WEEKS }}
        run: |
          echo "ğŸš€ Starting deployment..."

          if [ -z "$ADMIN_TOKEN" ]; then
            echo "âŒ ADMIN_TOKEN secret is empty"
            exit 1
          fi

          # Docker Compose ä¼šå¯¹ .env ä¸­çš„ '$' è¿›è¡Œå˜é‡æ’å€¼ï¼Œéœ€è¦å…ˆè½¬ä¹‰ä¸º '$$'
          escape_compose_env() {
            printf '%s' "${1//\$/\$\$}"
          }

          DB_USER_ESCAPED=$(escape_compose_env "${DB_USER}")
          DB_PASSWORD_ESCAPED=$(escape_compose_env "${DB_PASSWORD}")
          DB_NAME_ESCAPED=$(escape_compose_env "${DB_NAME}")
          DEEPSEEK_API_KEY_ESCAPED=$(escape_compose_env "${DEEPSEEK_API_KEY}")
          DEEPSEEK_BASE_URL_ESCAPED=$(escape_compose_env "${DEEPSEEK_BASE_URL}")
          OPENAI_API_KEY_ESCAPED=$(escape_compose_env "${OPENAI_API_KEY}")
          OPENAI_BASE_URL_ESCAPED=$(escape_compose_env "${OPENAI_BASE_URL}")
          TEACHER_DEEPSEEK_API_KEY_ESCAPED=$(escape_compose_env "${TEACHER_DEEPSEEK_API_KEY}")
          TEACHER_OPENROUTER_API_KEY_ESCAPED=$(escape_compose_env "${TEACHER_OPENROUTER_API_KEY}")
          ADMIN_TOKEN_ESCAPED=$(escape_compose_env "${ADMIN_TOKEN}")
          API_KEY_ENCRYPTION_KEY_ESCAPED=$(escape_compose_env "${API_KEY_ENCRYPTION_KEY}")
          STUDENT_REGISTRATION_CODE_ESCAPED=$(escape_compose_env "${STUDENT_REGISTRATION_CODE}")
          STUDENT_SELF_REGISTER_DEFAULT_QUOTA_ESCAPED=$(escape_compose_env "${STUDENT_SELF_REGISTER_DEFAULT_QUOTA}")
          CORS_ORIGINS_ESCAPED=$(escape_compose_env "${CORS_ORIGINS}")
          RATE_LIMIT_REQUESTS_PER_MINUTE_ESCAPED=$(escape_compose_env "${RATE_LIMIT_REQUESTS_PER_MINUTE}")
          RATE_LIMIT_BURST_SIZE_ESCAPED=$(escape_compose_env "${RATE_LIMIT_BURST_SIZE}")
          LOG_LEVEL_ESCAPED=$(escape_compose_env "${LOG_LEVEL}")
          LOG_FORMAT_ESCAPED=$(escape_compose_env "${LOG_FORMAT}")
          SEMESTER_START_DATE_ESCAPED=$(escape_compose_env "${SEMESTER_START_DATE}")
          SEMESTER_WEEKS_ESCAPED=$(escape_compose_env "${SEMESTER_WEEKS}")
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          ssh deploy "mkdir -p ~/teachproxy"
          
          # å¤åˆ¶éƒ¨ç½²æ–‡ä»¶
          scp docker-compose.yml deploy:~/teachproxy/
          scp Dockerfile deploy:~/teachproxy/
          scp docker-entrypoint.sh deploy:~/teachproxy/
          scp pyproject.toml deploy:~/teachproxy/
          scp uv.lock deploy:~/teachproxy/
          scp -r init-scripts deploy:~/teachproxy/
          scp -r nginx deploy:~/teachproxy/
          scp -r gateway deploy:~/teachproxy/
          scp -r admin deploy:~/teachproxy/
          scp -r web deploy:~/teachproxy/
          
          # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆé€šè¿‡ env å˜é‡æ³¨å…¥ï¼Œé¿å… secrets è¢« shell äºŒæ¬¡è§£æï¼‰
          cat > .env.deploy <<EOF
          # Database
          DB_USER=${DB_USER_ESCAPED}
          DB_PASSWORD=${DB_PASSWORD_ESCAPED}
          DB_NAME=${DB_NAME_ESCAPED}
          
          # AI Providers
          DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY_ESCAPED}
          DEEPSEEK_BASE_URL=${DEEPSEEK_BASE_URL_ESCAPED}
          OPENAI_API_KEY=${OPENAI_API_KEY_ESCAPED}
          OPENAI_BASE_URL=${OPENAI_BASE_URL_ESCAPED}
          
          # Balance Architecture
          TEACHER_DEEPSEEK_API_KEY=${TEACHER_DEEPSEEK_API_KEY_ESCAPED}
          TEACHER_OPENROUTER_API_KEY=${TEACHER_OPENROUTER_API_KEY_ESCAPED}
          
          # Security
          ADMIN_TOKEN=${ADMIN_TOKEN_ESCAPED}
          API_KEY_ENCRYPTION_KEY=${API_KEY_ENCRYPTION_KEY_ESCAPED}
          STUDENT_REGISTRATION_CODE=${STUDENT_REGISTRATION_CODE_ESCAPED}
          STUDENT_SELF_REGISTER_DEFAULT_QUOTA=${STUDENT_SELF_REGISTER_DEFAULT_QUOTA_ESCAPED:-10000}
          CORS_ORIGINS=${CORS_ORIGINS_ESCAPED:-[]}
          
          # Rate Limiting
          RATE_LIMIT_REQUESTS_PER_MINUTE=${RATE_LIMIT_REQUESTS_PER_MINUTE_ESCAPED:-60}
          RATE_LIMIT_BURST_SIZE=${RATE_LIMIT_BURST_SIZE_ESCAPED:-10}
          
          # Logging
          LOG_LEVEL=${LOG_LEVEL_ESCAPED:-INFO}
          LOG_FORMAT=${LOG_FORMAT_ESCAPED:-json}
          
          # Semester
          SEMESTER_START_DATE=${SEMESTER_START_DATE_ESCAPED:-2026-02-17}
          SEMESTER_WEEKS=${SEMESTER_WEEKS_ESCAPED:-16}
          EOF
          scp .env.deploy deploy:~/teachproxy/.env
          rm -f .env.deploy
          
          # ç”Ÿæˆ Nginx é…ç½®æ–‡ä»¶ï¼ˆä½¿ç”¨ HTTP æ¨¡å¼ï¼‰
          ssh deploy "cp ~/teachproxy/nginx/conf.d/default.conf ~/teachproxy/nginx/conf.d/app.conf"
          
          echo "âœ… Files copied successfully"

      # æ‰§è¡Œéƒ¨ç½²
      - name: Execute deployment
        run: |
          echo "ğŸ³ Deploying containers..."
          
          ssh deploy << 'DEPLOY'
            cd ~/teachproxy
            
            # åœæ­¢æ—§å®¹å™¨
            echo "ğŸ›‘ Stopping old containers..."
            docker compose down --timeout 30 2>/dev/null || true
            
            # æ¸…ç†æ—§é•œåƒï¼ˆä»…æ¸…ç†æœªä½¿ç”¨çš„ï¼Œä¿ç•™ç¼“å­˜ï¼‰
            echo "ğŸ§¹ Cleaning up unused images..."
            docker image prune -f 2>/dev/null || true
            
            # æ‹‰å–åŸºç¡€é•œåƒå¹¶æ„å»ºï¼ˆä½¿ç”¨ BuildKit å¼ºåˆ¶é‡å»ºåº”ç”¨å±‚ï¼‰
            echo "ğŸ”¨ Building containers..."
            docker compose pull
            DOCKER_BUILDKIT=1 docker compose build --no-cache --progress=plain
            
            # å¯åŠ¨æœåŠ¡
            echo "ğŸš€ Starting services..."
            docker compose up -d
            
            # å¥åº·æ£€æŸ¥ï¼ˆä¸å›ºå®šç­‰å¾…ï¼Œç›´æ¥æ£€æŸ¥ï¼‰
            echo "ğŸ¥ Running health check..."
            MAX_RETRIES=15
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              # æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
              if ! docker compose ps --status running --services api | grep -qx "api"; then
                echo "â³ Container not ready yet..."
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep 3
                continue
              fi
              
              # æ£€æŸ¥å¥åº·ç«¯ç‚¹ï¼ˆç›´æ¥æ£€æŸ¥ APIï¼‰
              echo "â³ Checking health endpoint..."
              HEALTH_RESPONSE=$(docker compose exec -T api curl -s -w "\n%{http_code}" http://localhost:8000/health 2>&1)
              HTTP_CODE=$(echo "$HEALTH_RESPONSE" | tail -n1)
              BODY=$(echo "$HEALTH_RESPONSE" | head -n -1)

              if [ "$HTTP_CODE" = "200" ]; then
                echo "âœ… API is healthy: $BODY"
                break
              else
                echo "âš ï¸ Health check returned HTTP $HTTP_CODE: $BODY"
              fi
              
              # æ£€æŸ¥å®¹å™¨æ—¥å¿—æ˜¯å¦æœ‰å¯åŠ¨é”™è¯¯
              if docker compose logs api --tail 5 2>/dev/null | grep -qi "error"; then
                echo "âš ï¸ Detected errors in container logs:"
                docker compose logs api --tail 20
              fi
              
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "â³ Health check attempt $RETRY_COUNT/$MAX_RETRIES..."
              sleep 3
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ Health check failed after $MAX_RETRIES attempts"
              echo "ğŸ“‹ Container logs:"
              docker compose logs api --tail 100
              echo "ğŸ“‹ Nginx logs:"
              docker compose logs nginx --tail 50 2>/dev/null || echo "No nginx logs available"
              echo "ğŸ“‹ Container status:"
              docker compose ps
              echo "ğŸ“‹ Verifying API health from inside container network:"
              docker compose exec -T api curl -sS -w "\n%{http_code}" http://localhost:8000/health 2>&1 || true
              exit 1
            fi
            
            echo "âœ… Deployment completed successfully!"
          DEPLOY

      # é€šçŸ¥éƒ¨ç½²ç»“æœ
      - name: Notify deployment result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "ğŸŒ Application is available at: http://${{ secrets.SSH_HOST }}"
          else
            echo "âŒ Deployment failed!"
          fi
