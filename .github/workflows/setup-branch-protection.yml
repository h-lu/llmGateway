name: Setup Branch Protection

on:
  workflow_dispatch:  # ÊâãÂä®Ëß¶Âèë

jobs:
  setup-protection:
    runs-on: ubuntu-latest
    steps:
      - name: Configure Branch Protection for main
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = 'main';
            
            try {
              await github.rest.repos.updateBranchProtection({
                owner,
                repo,
                branch,
                required_status_checks: {
                  strict: true,
                  contexts: ['Backend Tests', 'Backend Lint', 'Frontend Tests', 'Frontend Lint', 'Frontend Build Check']
                },
                enforce_admins: true,
                required_pull_request_reviews: {
                  required_approving_review_count: 1,
                  dismiss_stale_reviews: true,
                  require_code_owner_reviews: false
                },
                restrictions: null,
                allow_force_pushes: false,
                allow_deletions: false,
                required_conversation_resolution: true
              });
              
              console.log('‚úÖ Branch protection rules configured successfully!');
              console.log('');
              console.log('üìã Applied rules:');
              console.log('  ‚Ä¢ Require PR before merging: ‚úÖ');
              console.log('  ‚Ä¢ Require 1 approval: ‚úÖ');
              console.log('  ‚Ä¢ Dismiss stale reviews: ‚úÖ');
              console.log('  ‚Ä¢ Require status checks: ‚úÖ');
              console.log('  ‚Ä¢ Require branches up to date: ‚úÖ');
              console.log('  ‚Ä¢ Require conversation resolution: ‚úÖ');
              console.log('  ‚Ä¢ Include administrators: ‚úÖ');
              console.log('');
              console.log('‚ö†Ô∏è  Note: If this is a private repository, you may need GitHub Pro.');
              
            } catch (error) {
              console.error('‚ùå Error configuring branch protection:', error.message);
              console.log('');
              console.log('üí° For private repositories, you need to manually configure:');
              console.log('   https://github.com/' + owner + '/' + repo + '/settings/branches');
              core.setFailed(error.message);
            }
